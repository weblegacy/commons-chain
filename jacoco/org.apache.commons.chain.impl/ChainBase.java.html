<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChainBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Commons Chain</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.chain.impl</a> &gt; <span class="el_source">ChainBase.java</span></div><h1>ChainBase.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.chain.impl;

import java.util.Arrays;
import java.util.Collection;

import org.apache.commons.chain.Chain;
import org.apache.commons.chain.Command;
import org.apache.commons.chain.Context;
import org.apache.commons.chain.Filter;
import org.apache.commons.chain.internal.Utilities;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * Convenience base class for {@link Chain} implementations.
 *
 * @param &lt;C&gt; Type of the context associated with this chain
 *
 * @author Craig R. McClanahan
 * @version $Revision$ $Date$
 */
public class ChainBase&lt;C extends Context&gt; implements Chain&lt;C&gt; {

    // ----------------------------------------------------------- Constructors

    /**
     * Construct a {@link Chain} with no configured {@link Command}s.
     */
<span class="fc" id="L45">    public ChainBase() {</span>
<span class="fc" id="L46">    }</span>

    /**
     * Construct a {@link Chain} configured with the specified
     * {@link Command}.
     *
     * @param command The {@link Command} to be configured
     *
     * @throws IllegalArgumentException if {@code command}
     *         is {@code null}
     */
<span class="nc" id="L57">    public ChainBase(Command&lt;C&gt; command) {</span>
<span class="nc" id="L58">        addCommand(command);</span>
<span class="nc" id="L59">    }</span>

    /**
     * Construct a {@link Chain} configured with the specified
     * {@link Command}s.
     *
     * @param commands The {@link Command}s to be configured
     *
     * @throws IllegalArgumentException if {@code commands},
     *         or one of the individual {@link Command} elements,
     *         is {@code null}
     */
<span class="nc" id="L71">    public ChainBase(Command&lt;C&gt;[] commands) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (commands == null) {</span>
<span class="nc" id="L73">            throw new IllegalArgumentException();</span>
        }
<span class="nc bnc" id="L75" title="All 2 branches missed.">        for (Command&lt;C&gt; command : commands) {</span>
<span class="nc" id="L76">            addCommand(command);</span>
        }
<span class="nc" id="L78">    }</span>

    /**
     * Construct a {@link Chain} configured with the specified
     * {@link Command}s.
     *
     * @param commands The {@link Command}s to be configured
     *
     * @throws IllegalArgumentException if {@code commands},
     *         or one of the individual {@link Command} elements,
     *         is {@code null}
     */
<span class="nc" id="L90">    public ChainBase(Collection&lt;Command&lt;C&gt;&gt; commands) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (commands == null) {</span>
<span class="nc" id="L92">            throw new IllegalArgumentException();</span>
        }
<span class="nc" id="L94">        commands.forEach(this::addCommand);</span>
<span class="nc" id="L95">    }</span>

    // ----------------------------------------------------- Instance Variables

    /**
     * The list of {@link Command}s configured for this {@link Chain}, in
     * the order in which they may delegate processing to the remainder of
     * the {@link Chain}.
     */
<span class="pc" id="L104">    private Command&lt;C&gt;[] commands = Utilities.newArray(Command.class, 0);</span>

    /**
     * Flag indicating whether the configuration of our commands list
     * has been frozen by a call to the {@code execute()} method.
     */
<span class="pc" id="L110">    private boolean frozen = false;</span>

    // ---------------------------------------------------------- Chain Methods

    /**
     * See the {@link Chain} JavaDoc.
     *
     * @param command The {@link Command} to be added
     *
     * @throws IllegalArgumentException if {@code command}
     *         is {@code null}
     * @throws IllegalStateException if no further configuration is allowed
     */
    @Override
    public &lt;CMD extends Command&lt;C&gt;&gt; void addCommand(CMD command) {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (command == null) {</span>
<span class="nc" id="L126">            throw new IllegalArgumentException();</span>
        }
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (frozen) {</span>
<span class="nc" id="L129">            throw new IllegalStateException();</span>
        }
<span class="fc" id="L131">        final int len = commands.length;</span>
<span class="fc" id="L132">        commands = Arrays.copyOf(commands, len + 1);</span>
<span class="fc" id="L133">        commands[len] = command;</span>
<span class="fc" id="L134">    }</span>

    /**
     * See the {@link Chain} JavaDoc.
     *
     * @param context The {@link Context} to be processed by this
     *  {@link Chain}
     *
     * @return {@code true} if the processing of this {@link Context}
     *         has been completed, or {@code false} if the processing
     *         of this {@link Context} should be delegated to a
     *         subsequent {@link Command} in an enclosing {@link Chain}
     *
     * @throws Exception if thrown by one of the {@link Command}s
     *         in this {@link Chain} but not handled by a
     *         {@code postprocess()} method of a {@link Filter}
     * @throws IllegalArgumentException if {@code context}
     *         is {@code null}
     */
    @Override
    public boolean execute(C context) throws Exception {
        // Verify our parameters
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        if (context == null) {</span>
<span class="nc" id="L157">            throw new IllegalArgumentException();</span>
        }

        // Freeze the configuration of the command list
<span class="fc" id="L161">        frozen = true;</span>

        // Execute the commands in this list until one returns true
        // or throws an exception
<span class="fc" id="L165">        boolean saveResult = false;</span>
<span class="fc" id="L166">        Exception saveException = null;</span>
<span class="fc" id="L167">        int i = 0;</span>
<span class="fc" id="L168">        int n = commands.length;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        for (i = 0; i &lt; n; i++) {</span>
            try {
<span class="fc" id="L171">                saveResult = commands[i].execute(context);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">                if (saveResult) {</span>
<span class="fc" id="L173">                    break;</span>
                }
<span class="nc" id="L175">            } catch (Exception e) {</span>
<span class="nc" id="L176">                saveException = e;</span>
<span class="nc" id="L177">                break;</span>
<span class="fc" id="L178">            }</span>
        }

        // Call postprocess methods on Filters in reverse order
<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (i &gt;= n) { // Fell off the end of the chain</span>
<span class="fc" id="L183">            i--;</span>
        }
<span class="fc" id="L185">        boolean handled = false;</span>
<span class="fc" id="L186">        boolean result = false;</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">        for (int j = i; j &gt;= 0; j--) {</span>
<span class="fc" id="L188">            Command&lt;C&gt; command = commands[j];</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">            if (command instanceof Filter) {</span>
                try {
<span class="fc" id="L191">                    result =</span>
<span class="fc" id="L192">                        ((Filter&lt;C&gt;) command).postprocess(context,</span>
                                                          saveException);
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">                    if (result) {</span>
<span class="nc" id="L195">                        handled = true;</span>
                    }
<span class="nc" id="L197">                } catch (Exception e) {</span>
                    // Silently ignore
<span class="nc" id="L199">                    Log log = LogFactory.getLog(ChainBase.class);</span>
<span class="nc" id="L200">                    log.trace(&quot;Filter-postprocessing&quot;, e);</span>
<span class="fc" id="L201">                }</span>
            }
        }

        // Return the exception or result state from the last execute()
<span class="pc bpc" id="L206" title="3 of 4 branches missed.">        if (saveException != null &amp;&amp; !handled) {</span>
<span class="nc" id="L207">            throw saveException;</span>
        } else {
<span class="fc" id="L209">            return saveResult;</span>
        }
    }

    /**
     * Returns {@code true}, if the configuration of our commands list
     * has been frozen by a call to the {@code execute()} method,
     * {@code false} otherwise.
     *
     * @return {@code true}, if the configuration of our commands list
     * has been frozen by a call to the {@code execute()} method,
     * {@code false} otherwise.
     *
     * @since 1.3
     */
    public boolean isFrozen() {
<span class="nc" id="L225">        return frozen;</span>
    }

    // -------------------------------------------------------- Package Methods

    /**
     * Return an array of the configured {@link Command}s for this
     * {@link Chain}. This method is package private, and is used only
     * for the unit tests.
     *
     * @return an array of the configured {@link Command}s for this {@link Chain}
     */
    Command&lt;C&gt;[] getCommands() {
<span class="fc" id="L238">        return commands;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>